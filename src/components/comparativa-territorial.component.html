<!-- RUTA: src/app/components/comparativa-territorial.component.html -->

<div class="flex flex-col h-screen w-full overflow-hidden bg-[#F0EEF5] font-sans animate-fade-in"
     (click)="closeAll()">

  <!-- ══════════════════════════════════════════════════════════════════
       HEADER — 3 NIVELES (igual estructura que el Dashboard)
       ══════════════════════════════════════════════════════════════════ -->
  <header class="flex-shrink-0 z-40 shadow-xl">

    <!-- NIVEL 1 — #8B4996 : Logos + título institucional -->
    <div class="bg-[#8B4996] text-white flex justify-between items-center px-4 md:px-6 py-2 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="bg-white p-1.5 rounded-md shadow-md flex-shrink-0">
          <img src="assets/images/logo.png" alt="INEI" class="h-8 w-auto object-contain">
        </div>
        <div class="bg-white p-1.5 rounded-md shadow-md flex-shrink-0">
          <img src="assets/images/logo-cpv.png" alt="CPV 2025" class="h-8 w-auto object-contain">
        </div>
        <div class="ml-1 hidden md:flex flex-col">
          <p class="text-[9px] text-purple-200 uppercase tracking-widest font-semibold leading-none mb-0.5">
            Instituto Nacional de Estadística e Informática
          </p>
          <h1 class="text-sm font-black uppercase text-white leading-tight">
            Censos Nacionales de Población y Vivienda
            <span class="text-yellow-300 ml-1">CPV 2025</span>
          </h1>
        </div>
      </div>
      <div class="flex items-center gap-3 flex-shrink-0">
        <div class="text-right hidden sm:block">
          <div class="text-[9px] text-purple-200 uppercase font-bold tracking-widest">INEI — Visitantes</div>
          <div class="text-sm font-mono font-bold">1,256,456</div>
        </div>
        <div class="bg-white/10 border border-white/20 p-1.5 rounded-full hover:bg-white/20 cursor-pointer transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- NIVEL 2 — #72387c : Navegación secundaria -->
    <nav class="bg-[#72387c] text-white flex items-center justify-end gap-1 px-4 md:px-6 py-1 border-b border-white/10">
      <!-- Inicio -->
      <button (click)="goToLanding.emit()"
              class="flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-semibold text-white/90 hover:bg-white/15 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        Inicio
      </button>
      <div class="w-px h-3.5 bg-white/20 mx-0.5"></div>
      <!-- Primeros Resultados (dashboard) -->
      <!--<button (click)="goToDashboard.emit()"
              class="flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-semibold text-white/90 hover:bg-white/15 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Primeros Resultados
      </button> -->
    </nav>

    <!-- NIVEL 3 — #C5328A : Tabs de vista + filtros -->
    <div class="bg-[#C5328A] text-white flex justify-between items-center px-4 md:px-6 py-1.5"
         (click)="$event.stopPropagation()">

      <!-- Tabs: Población | Comparativo Territorial (activo) -->
      <div class="flex items-center gap-1">
        <!-- Población → vuelve al dashboard -->
        <button (click)="goToDashboard.emit()"
                class="flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-semibold text-white/80 hover:bg-white/15 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span class="hidden sm:inline">Población</span>
        </button>
        <!-- Comparativo Territorial — ACTIVO -->
        <button class="flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-bold bg-white text-[#C5328A] shadow cursor-default">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
          <span class="hidden sm:inline">Comparativo Territorial</span>
        </button>
      </div>

      <!-- Filtros desplegables -->
      <div class="flex items-center gap-2">

        <!-- ★ Nivel -->
        <div class="relative">
          <button (click)="toggleDropdown('nivel'); $event.stopPropagation()"
                  class="flex items-center gap-1.5 px-2.5 py-1 bg-white/15 border border-white/30 rounded-md
                         text-xs font-semibold text-white hover:bg-white/25 transition-colors min-w-[140px] justify-between">
            <span><span class="text-pink-100 mr-1">Nivel:</span>{{ nivelActivo() }}</span>
            <svg class="w-3 h-3 text-white/70 transition-transform flex-shrink-0"
                 [class.rotate-180]="openDropdown() === 'nivel'"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          @if (openDropdown() === 'nivel') {
            <div class="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 min-w-[160px] overflow-hidden"
                 (click)="$event.stopPropagation()">
              @for (n of NIVELES; track n) {
                <button (click)="setNivel(n)"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-left transition-colors"
                        [class.bg-[#C5328A]]="nivelActivo() === n"
                        [class.text-white]="nivelActivo() === n"
                        [class.text-gray-700]="nivelActivo() !== n"
                        [class.hover:bg-pink-50]="nivelActivo() !== n">
                  <span class="w-3.5 h-3.5 rounded-full border flex-shrink-0 flex items-center justify-center"
                        [class.border-white]="nivelActivo() === n"
                        [class.border-gray-300]="nivelActivo() !== n">
                    @if (nivelActivo() === n) {
                      <span class="w-2 h-2 bg-white rounded-full block"></span>
                    }
                  </span>
                  <span class="font-semibold">{{ n }}</span>
                </button>
              }
            </div>
          }
        </div>

        <!-- ★ Departamento -->
        <div class="relative">
          <button (click)="toggleDropdown('dep'); $event.stopPropagation()"
                  class="flex items-center gap-1.5 px-2.5 py-1 bg-white/15 border border-white/30 rounded-md
                         text-xs font-semibold text-white hover:bg-white/25 transition-colors min-w-[155px] justify-between">
            <span><span class="text-pink-100 mr-1">Dep.:</span>{{ depLabel() }}</span>
            <svg class="w-3 h-3 text-white/70 flex-shrink-0 transition-transform"
                 [class.rotate-180]="openDropdown() === 'dep'"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          @if (openDropdown() === 'dep') {
            <div class="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 w-56 overflow-hidden"
                 (click)="$event.stopPropagation()">
              <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 border-b border-gray-100 cursor-pointer hover:bg-gray-100 text-xs font-bold text-gray-600">
                <input type="checkbox" [checked]="allDepsOn()" (change)="toggleAllDeps()"
                       class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                Seleccionar todos
              </label>
              <div class="max-h-56 overflow-y-auto">
                @for (item of depsItems(); track item.label; let i = $index) {
                  <label class="flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-pink-50 text-xs text-gray-700 transition-colors">
                    <input type="checkbox" [checked]="item.checked" (change)="toggleDep(i)"
                           class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                    {{ item.label }}
                  </label>
                }
              </div>
            </div>
          }
        </div>

        <!-- ★ Provincia -->
        <div class="relative">
          <button (click)="isProvActive() && toggleDropdown('prov'); $event.stopPropagation()"
                  class="flex items-center gap-1.5 px-2.5 py-1 border rounded-md text-xs font-semibold
                         transition-colors min-w-[155px] justify-between"
                  [class.bg-white/15]="isProvActive()"
                  [class.border-white/30]="isProvActive()"
                  [class.text-white]="isProvActive()"
                  [class.hover:bg-white/25]="isProvActive()"
                  [class.bg-white/5]="!isProvActive()"
                  [class.border-white/15]="!isProvActive()"
                  [class.text-white/35]="!isProvActive()"
                  [class.cursor-not-allowed]="!isProvActive()">
            <span><span class="mr-1" [class.text-pink-100]="isProvActive()">Prov.:</span>{{ provLabel() }}</span>
            <svg class="w-3 h-3 flex-shrink-0 transition-transform"
                 [class.text-white/70]="isProvActive()"
                 [class.text-white/25]="!isProvActive()"
                 [class.rotate-180]="openDropdown() === 'prov'"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          @if (openDropdown() === 'prov' && isProvActive()) {
            <div class="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 w-60 overflow-hidden"
                 (click)="$event.stopPropagation()">
              <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 border-b border-gray-100 cursor-pointer hover:bg-gray-100 text-xs font-bold text-gray-600">
                <input type="checkbox" [checked]="allProvsOn()" (change)="toggleAllProvs()"
                       class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                Seleccionar todas
              </label>
              <div class="max-h-56 overflow-y-auto">
                @for (item of provsItems(); track item.label; let i = $index) {
                  <label class="flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-pink-50 text-xs text-gray-700 transition-colors">
                    <input type="checkbox" [checked]="item.checked" (change)="toggleProv(i)"
                           class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                    {{ item.label }}
                  </label>
                }
              </div>
            </div>
          }
        </div>

        <!-- ★ Distrito -->
        <div class="relative">
          <button (click)="isDistActive() && toggleDropdown('dist'); $event.stopPropagation()"
                  class="flex items-center gap-1.5 px-2.5 py-1 border rounded-md text-xs font-semibold
                         transition-colors min-w-[150px] justify-between"
                  [class.bg-white/15]="isDistActive()"
                  [class.border-white/30]="isDistActive()"
                  [class.text-white]="isDistActive()"
                  [class.hover:bg-white/25]="isDistActive()"
                  [class.bg-white/5]="!isDistActive()"
                  [class.border-white/15]="!isDistActive()"
                  [class.text-white/35]="!isDistActive()"
                  [class.cursor-not-allowed]="!isDistActive()">
            <span><span class="mr-1" [class.text-pink-100]="isDistActive()">Dist.:</span>{{ distLabel() }}</span>
            <svg class="w-3 h-3 flex-shrink-0 transition-transform"
                 [class.text-white/70]="isDistActive()"
                 [class.text-white/25]="!isDistActive()"
                 [class.rotate-180]="openDropdown() === 'dist'"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          @if (openDropdown() === 'dist' && isDistActive()) {
            <div class="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 w-72 overflow-hidden"
                 (click)="$event.stopPropagation()">
              <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 border-b border-gray-100 cursor-pointer hover:bg-gray-100 text-xs font-bold text-gray-600">
                <input type="checkbox" [checked]="allDistsOn()" (change)="toggleAllDists()"
                       class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                Seleccionar todos
              </label>
              <div class="max-h-56 overflow-y-auto">
                @for (item of distItems(); track item.label; let i = $index) {
                  <label class="flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-pink-50 text-xs text-gray-700 transition-colors">
                    <input type="checkbox" [checked]="item.checked" (change)="toggleDist(i)"
                           class="rounded border-gray-300 text-[#C5328A] focus:ring-[#C5328A] w-3.5 h-3.5">
                    {{ item.label }}
                  </label>
                }
              </div>
            </div>
          }
        </div>

      </div>
    </div>
  </header>

  <!-- ══════════════════════════════════════════════════════════════════
       CUERPO — Tabla estadística tabular (estilo Excel/INEI)
       ══════════════════════════════════════════════════════════════════ -->
  <main class="flex-1 overflow-hidden flex flex-col min-h-0 p-3">
    <div class="flex-1 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-0">

      <!-- Barra de estado de la tabla -->
      <div class="flex items-center justify-between px-4 py-2 bg-[#8B4996]/5 border-b border-[#8B4996]/10 flex-shrink-0">
        <div class="flex items-center gap-3">
          <span class="flex items-center gap-1.5 text-[10px] font-black text-[#8B4996] uppercase tracking-widest">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18M10 3v18M6 3h12a1 1 0 011 1v16a1 1 0 01-1 1H6a1 1 0 01-1-1V4a1 1 0 011-1z"/>
            </svg>
            Cuadro {{ nivelActivo() }}
          </span>
          <span class="h-3 w-px bg-gray-300"></span>
          <span class="text-[10px] text-gray-500">
            CPV 2025 — Resultados Preliminares
          </span>
          <span class="h-3 w-px bg-gray-300"></span>
          <span class="text-[10px] text-gray-500 font-semibold">
            {{ filasTabla().length }} registro{{ filasTabla().length !== 1 ? 's' : '' }}
          </span>
        </div>
        <!-- Totales rápidos -->
        <div class="hidden md:flex items-center gap-4 text-[10px]">
          <span class="text-gray-500">Pobl. total: <strong class="text-[#8B4996]">{{ fmtN(totales().pob) }}</strong></span>
          <span class="text-[#5A9CF8]">H: <strong>{{ fmtN(totales().hom) }}</strong></span>
          <span class="text-[#D45D79]">M: <strong>{{ fmtN(totales().muj) }}</strong></span>
        </div>
      </div>

      <!-- Tabla con scroll -->
      <div class="overflow-auto flex-1">
        <table class="w-full text-[11px] border-collapse">

          <!-- ── THEAD ── -->
          <thead class="sticky top-0 z-10">
            <!-- Fila de grupos de columnas -->
            <tr>
              <!-- Grupo: Ubicación geográfica -->
              <th class="bg-[#3d1d45] text-white px-3 py-1.5 text-left font-bold uppercase tracking-wider text-[9px] border-r border-white/20"
                  [attr.colspan]="nivelActivo() === 'Departamental' ? 1 : nivelActivo() === 'Provincial' ? 2 : 3">
                Ubicación Geográfica
              </th>
              <!-- Grupo: Territorio -->
              <th class="bg-[#3d1d45] text-white px-3 py-1.5 text-center font-bold uppercase tracking-wider text-[9px] border-r border-white/20"
                  colspan="2">
                Territorio
              </th>
              <!-- Grupo: Población -->
              <th class="bg-[#3d1d45] text-white px-3 py-1.5 text-center font-bold uppercase tracking-wider text-[9px] border-r border-white/20"
                  colspan="3">
                Población Censada
              </th>
              <!-- Grupo: Demografía -->
              <th class="bg-[#3d1d45] text-white px-3 py-1.5 text-center font-bold uppercase tracking-wider text-[9px] border-r border-white/20"
                  colspan="2">
                Indicadores Demográficos
              </th>
              <!-- Grupo: Adultos mayores -->
              <th class="bg-[#3d1d45] text-white px-3 py-1.5 text-center font-bold uppercase tracking-wider text-[9px]"
                  colspan="2">
                Adultos Mayores (65+)
              </th>
            </tr>
            <!-- Fila de columnas específicas -->
            <tr>
              <!-- Ubicación -->
              <th class="bg-[#72387c] text-white px-3 py-2 text-left font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Departamento
              </th>
              @if (nivelActivo() === 'Provincial' || nivelActivo() === 'Distrital') {
                <th class="bg-[#72387c] text-white px-3 py-2 text-left font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                  Provincia
                </th>
              }
              @if (nivelActivo() === 'Distrital') {
                <th class="bg-[#72387c] text-white px-3 py-2 text-left font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                  Distrito
                </th>
              }
              <!-- Territorio -->
              <th class="bg-[#8B4996] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Sup. (km²)
              </th>
              <th class="bg-[#8B4996] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Densidad<br><span class="text-purple-200 font-normal text-[9px]">(hab/km²)</span>
              </th>
              <!-- Población -->
              <th class="bg-[#C5328A] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Total
              </th>
              <th class="bg-[#C5328A] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Hombres
              </th>
              <th class="bg-[#C5328A] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Mujeres
              </th>
              <!-- Demografía -->
              <th class="bg-[#a0256e] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Razón H/M
              </th>
              <th class="bg-[#a0256e] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Edad<br><span class="text-pink-200 font-normal text-[9px]">Mediana</span>
              </th>
              <!-- Adultos mayores -->
              <th class="bg-[#7b3f6e] text-white px-3 py-2 text-right font-semibold whitespace-nowrap border-r border-white/20 text-[10px]">
                Personas 65+
              </th>
              <th class="bg-[#7b3f6e] text-white px-3 py-2 text-right font-semibold whitespace-nowrap text-[10px]">
                % 65+
              </th>
            </tr>
          </thead>

          <!-- ── TBODY ── -->
          <tbody>
            @if (filasTabla().length === 0) {
              <tr>
                <td colspan="20" class="text-center py-20 text-gray-400">
                  <div class="flex flex-col items-center gap-2">
                    <svg class="w-10 h-10 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-sm font-semibold text-gray-500">Sin registros para mostrar</p>
                    <p class="text-xs text-gray-400">Activa al menos un elemento en cada filtro</p>
                  </div>
                </td>
              </tr>
            }

            @for (fila of filasTabla(); track $index; let even = $even) {
              <tr class="border-b border-gray-100 transition-colors hover:bg-[#C5328A]/5"
                  [class.bg-white]="!even"
                  [class.bg-purple-50/30]="even">

                <!-- Departamento -->
                <td class="px-3 py-2 font-semibold text-[#3d1d45] whitespace-nowrap border-r border-gray-100">
                  <span class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[#C5328A] flex-shrink-0"></span>
                    {{ fila.departamento }}
                  </span>
                </td>

                <!-- Provincia -->
                @if (nivelActivo() === 'Provincial' || nivelActivo() === 'Distrital') {
                  <td class="px-3 py-2 text-gray-700 whitespace-nowrap border-r border-gray-100">
                    {{ asProv(fila).provincia }}
                  </td>
                }

                <!-- Distrito -->
                @if (nivelActivo() === 'Distrital') {
                  <td class="px-3 py-2 text-gray-600 whitespace-nowrap border-r border-gray-100">
                    {{ asDist(fila).distrito }}
                  </td>
                }

                <!-- Superficie -->
                <td class="px-3 py-2 text-right font-mono text-gray-600 whitespace-nowrap border-r border-gray-100">
                  {{ fmtD(fila.superficie) }}
                </td>

                <!-- Densidad -->
                <td class="px-3 py-2 text-right font-mono text-gray-600 whitespace-nowrap border-r border-gray-100">
                  {{ fmtD(fila.densidad) }}
                </td>

                <!-- Población total -->
                <td class="px-3 py-2 text-right font-mono font-bold text-gray-800 whitespace-nowrap border-r border-gray-100">
                  {{ fmtN(fila.poblacion) }}
                </td>

                <!-- Hombres -->
                <td class="px-3 py-2 text-right font-mono text-[#5A9CF8] whitespace-nowrap border-r border-gray-100">
                  {{ fmtN(fila.hombres) }}
                </td>

                <!-- Mujeres -->
                <td class="px-3 py-2 text-right font-mono text-[#D45D79] whitespace-nowrap border-r border-gray-100">
                  {{ fmtN(fila.mujeres) }}
                </td>

                <!-- Razón H/M — con semáforo de color -->
                <td class="px-3 py-2 text-right whitespace-nowrap border-r border-gray-100">
                  <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold"
                        [class.bg-blue-100]="fila.razon >= 100"
                        [class.text-blue-700]="fila.razon >= 100"
                        [class.bg-rose-100]="fila.razon < 100"
                        [class.text-rose-700]="fila.razon < 100">
                    {{ fmtR(fila.razon) }}
                  </span>
                </td>

                <!-- Edad mediana -->
                <td class="px-3 py-2 text-right font-mono text-gray-700 whitespace-nowrap border-r border-gray-100">
                  {{ fmtR(fila.edadMediana) }}
                </td>

                <!-- Personas 65+ -->
                <td class="px-3 py-2 text-right font-mono text-[#8B4996] whitespace-nowrap border-r border-gray-100">
                  {{ fmtN(fila.p65) }}
                </td>

                <!-- % 65+ — con semáforo -->
                <td class="px-3 py-2 text-right whitespace-nowrap">
                  <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold"
                        [class.bg-purple-100]="fila.pct65 >= 10"
                        [class.text-purple-700]="fila.pct65 >= 10"
                        [class.bg-amber-50]="fila.pct65 >= 7 && fila.pct65 < 10"
                        [class.text-amber-700]="fila.pct65 >= 7 && fila.pct65 < 10"
                        [class.bg-gray-100]="fila.pct65 < 7"
                        [class.text-gray-600]="fila.pct65 < 7">
                    {{ fmtPct(fila.pct65) }}
                  </span>
                </td>

              </tr>
            }
          </tbody>

          <!-- ── TFOOT — Totales ── -->
          @if (filasTabla().length > 1) {
            <tfoot>
              <tr class="border-t-2 border-[#8B4996]/30 bg-[#8B4996]/8 font-bold">
                <td class="px-3 py-2.5 text-[#3d1d45] text-[10px] font-black uppercase tracking-wider border-r border-gray-200"
                    [attr.colspan]="nivelActivo() === 'Departamental' ? 1 : nivelActivo() === 'Provincial' ? 2 : 3">
                  TOTAL / PROMEDIO
                </td>
                <!-- Superficie total -->
                <td class="px-3 py-2.5 text-right font-mono text-[10px] border-r border-gray-200">
                  {{ fmtD(totales().sup) }}
                </td>
                <!-- Densidad media -->
                <td class="px-3 py-2.5 text-right font-mono text-[10px] border-r border-gray-200">
                  {{ fmtD(totales().dens) }}
                </td>
                <!-- Población total -->
                <td class="px-3 py-2.5 text-right font-mono font-black text-gray-900 text-[11px] border-r border-gray-200">
                  {{ fmtN(totales().pob) }}
                </td>
                <!-- Hombres total -->
                <td class="px-3 py-2.5 text-right font-mono text-[#5A9CF8] font-bold text-[10px] border-r border-gray-200">
                  {{ fmtN(totales().hom) }}
                </td>
                <!-- Mujeres total -->
                <td class="px-3 py-2.5 text-right font-mono text-[#D45D79] font-bold text-[10px] border-r border-gray-200">
                  {{ fmtN(totales().muj) }}
                </td>
                <!-- Razón total -->
                <td class="px-3 py-2.5 text-right border-r border-gray-200">
                  <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-gray-200 text-gray-700">
                    {{ fmtR(totales().razon) }}
                  </span>
                </td>
                <!-- Edad mediana (—) -->
                <td class="px-3 py-2.5 text-center text-gray-400 border-r border-gray-200">—</td>
                <!-- Personas 65+ total -->
                <td class="px-3 py-2.5 text-right font-mono text-[#8B4996] font-bold text-[10px] border-r border-gray-200">
                  {{ fmtN(totales().p65) }}
                </td>
                <!-- % 65+ total -->
                <td class="px-3 py-2.5 text-right">
                  <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-gray-200 text-gray-700">
                    {{ fmtPct(totales().pct65) }}
                  </span>
                </td>
              </tr>
            </tfoot>
          }

        </table>
      </div>

      <!-- Nota metodológica -->
      <div class="flex items-start gap-2 px-4 py-2.5 bg-amber-50 border-t border-amber-200 flex-shrink-0">
        <svg class="w-3.5 h-3.5 text-amber-500 flex-shrink-0 mt-px" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <p class="text-[10px] text-amber-800 leading-relaxed">
          <strong>Nota metodológica:</strong> Resultados preliminares del Censo de Población y Vivienda 2025 (CPV 2025). Superficie en km² según IGN. Razón H/M expresada por cada 100 mujeres. Datos de nivel provincial y distrital corresponden a Ayacucho–Huamanga (datos de referencia). El porcentaje de área urbana considera los centros poblados clasificados como urbanos según el criterio de 2,000 habitantes o más.
        </p>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="flex-shrink-0 bg-[#3d1d45] text-white py-2 px-4 md:px-6 flex justify-between items-center z-40 border-t border-white/10">
    <div class="hidden md:block">
      <p class="text-[9px] text-purple-300 font-semibold uppercase tracking-widest">Instituto Nacional de Estadística e Informática</p>
      <p class="text-[9px] text-purple-400">Jr. General Garzón N° 658, Jesús María — Lima, Perú | (01) 203-3000</p>
    </div>
    <p class="text-[8px] text-purple-400">© 2026 INEI — CPV 2025 | Comparativa Territorial</p>
  </footer>

</div>